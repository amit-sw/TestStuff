<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schovia | Style Transfer Gym</title>
    <style>
      :root { --bg:#08101d; --panel:#101a2e; --panel2:#15233d; --line:#2a3f68; --text:#e8f0ff; --muted:#9db2d8; }
      * { box-sizing: border-box; }
      body { margin:0; background:radial-gradient(circle at 20% 10%, #172a4b, var(--bg) 45%), #08101d; color:var(--text); font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; }
      .app { width:min(1120px,95vw); margin:28px auto; display:grid; gap:14px; }
      .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .brand-lockup { margin-right:auto; }
      .brand-logo { height:52px; }
      .badge { font-size:.86rem; color:var(--muted); border:1px solid var(--line); border-radius:999px; padding:4px 10px; }
      .section { background:linear-gradient(165deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:14px; }
      .section h2 { margin:0 0 10px; color:var(--muted); font-size:1rem; }
      .controls { display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end; }
      label { display:block; color:var(--muted); font-size:.86rem; margin-bottom:6px; }
      input, button, select { width:100%; border-radius:10px; border:1px solid #2d4d82; background:#132746; color:var(--text); padding:8px 10px; }
      button { cursor:pointer; background:#1f5fbf; border-color:#184a95; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
      .stage { border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0b1529; }
      .stage img, .stage canvas { width:100%; display:block; max-height:58vh; object-fit:contain; }
      .row { display:flex; gap:10px; flex-wrap:wrap; }
      .pill { border-radius:999px; border:1px solid var(--line); padding:3px 8px; font-size:.8rem; color:var(--muted); }
      .hint { color:var(--muted); font-size:.88rem; }
      video { width:100%; max-height:240px; border-radius:12px; border:1px solid var(--line); background:#0b1529; }
      @media (max-width: 900px) { .controls, .grid { grid-template-columns:1fr; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  </head>
  <body>
    <main class="app">
      <div class="topbar">
        <div class="brand-lockup"><img class="brand-logo" src="https://schovia.com/wp-content/uploads/2025/09/backConcept-2-Color-copy-2.svg" alt="Schovia logo" /></div>
        <h1>Style Transfer</h1>
        <span class="badge">TF.js model-based combine</span>
      </div>

      <section class="section">
        <h2>Inputs</h2>
        <div class="controls">
          <div>
            <label>Content Image</label>
            <input id="contentFile" type="file" accept="image/*" />
          </div>
          <div>
            <label>Style Image</label>
            <input id="styleFile" type="file" accept="image/*" />
          </div>
          <div>
            <label>Actions</label>
            <button id="combineBtn" disabled>Loading models...</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="sampleBtn" type="button">Load Sample Pair</button>
          <button id="cameraBtn" type="button">Use Webcam as Content</button>
          <span id="status" class="pill">Initializing...</span>
        </div>
        <p class="hint">Uses AIClub model URLs: style + transformer graph models from pyxedapackages S3.</p>
      </section>

      <section class="section" id="cameraSection" style="display:none;">
        <h2>Webcam</h2>
        <video id="video" autoplay muted playsinline></video>
        <div class="row" style="margin-top:10px;"><button id="snapBtn">Capture Content Image</button><button id="closeCamBtn">Close Camera</button></div>
      </section>

      <section class="section">
        <h2>Result</h2>
        <div class="grid">
          <div class="stage"><img id="contentImg" alt="content" /></div>
          <div class="stage"><img id="styleImg" alt="style" /></div>
          <div class="stage"><canvas id="output"></canvas></div>
        </div>
      </section>
    </main>

    <script>
      const MODELS = {
        style: 'https://pyxedapackages.s3.amazonaws.com/models/saved_model_style_js/model.json',
        transform: 'https://pyxedapackages.s3.amazonaws.com/models/saved_model_transformer_js/model.json',
      };
      const SAMPLE_CONTENT = 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=900&q=80';
      const SAMPLE_STYLE = 'https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?auto=format&fit=crop&w=900&q=80';

      const contentFile = document.getElementById('contentFile');
      const styleFile = document.getElementById('styleFile');
      const contentImg = document.getElementById('contentImg');
      const styleImg = document.getElementById('styleImg');
      const output = document.getElementById('output');
      const combineBtn = document.getElementById('combineBtn');
      const statusEl = document.getElementById('status');
      const sampleBtn = document.getElementById('sampleBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraSection = document.getElementById('cameraSection');
      const video = document.getElementById('video');
      const snapBtn = document.getElementById('snapBtn');
      const closeCamBtn = document.getElementById('closeCamBtn');

      let styleNet = null;
      let transformNet = null;
      let stream = null;

      function setStatus(text) { statusEl.textContent = text; }

      function readFileToImg(file, target) {
        target.src = URL.createObjectURL(file);
      }

      async function loadModels() {
        setStatus('Loading style model...');
        styleNet = await tf.loadGraphModel(MODELS.style);
        setStatus('Loading transformer model...');
        transformNet = await tf.loadGraphModel(MODELS.transform);
        combineBtn.disabled = false;
        combineBtn.textContent = 'Combine';
        setStatus('Ready');
      }

      function asTensor(imgEl) {
        return tf.tidy(() => tf.browser.fromPixels(imgEl).toFloat().div(255).expandDims());
      }

      async function combine() {
        if (!contentImg.src || !styleImg.src) {
          alert('Select both content and style images first.');
          return;
        }
        if (!styleNet || !transformNet) return;

        combineBtn.disabled = true;
        combineBtn.textContent = 'Generating style bottleneck...';

        let stylized;
        try {
          const styleTensor = asTensor(styleImg);
          const contentTensor = asTensor(contentImg);
          const bottleneck = styleNet.predict(styleTensor);

          combineBtn.textContent = 'Stylizing image...';
          stylized = transformNet.predict([contentTensor, bottleneck]).squeeze();

          output.width = contentImg.naturalWidth || 640;
          output.height = contentImg.naturalHeight || 480;
          await tf.browser.toPixels(stylized, output);

          tf.dispose([styleTensor, contentTensor, bottleneck]);
          setStatus('Combined');
        } catch (err) {
          console.error(err);
          setStatus('Combine failed');
          alert('Style transfer failed.');
        } finally {
          if (stylized) stylized.dispose();
          combineBtn.disabled = false;
          combineBtn.textContent = 'Combine';
        }
      }

      async function openCamera() {
        cameraSection.style.display = 'block';
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
      }

      function closeCamera() {
        if (stream) stream.getTracks().forEach((t) => t.stop());
        stream = null;
        cameraSection.style.display = 'none';
      }

      function snapCamera() {
        if (!video.videoWidth) return;
        const c = document.createElement('canvas');
        c.width = video.videoWidth;
        c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
        contentImg.src = c.toDataURL('image/png');
      }

      contentFile.addEventListener('change', () => { const f = contentFile.files?.[0]; if (f) readFileToImg(f, contentImg); });
      styleFile.addEventListener('change', () => { const f = styleFile.files?.[0]; if (f) readFileToImg(f, styleImg); });
      combineBtn.addEventListener('click', combine);
      sampleBtn.addEventListener('click', () => { contentImg.crossOrigin = 'anonymous'; styleImg.crossOrigin = 'anonymous'; contentImg.src = SAMPLE_CONTENT; styleImg.src = SAMPLE_STYLE; });
      cameraBtn.addEventListener('click', () => openCamera().catch((e) => alert(e.message)));
      closeCamBtn.addEventListener('click', closeCamera);
      snapBtn.addEventListener('click', snapCamera);

      loadModels().catch((e) => { console.error(e); setStatus('Model load failed'); combineBtn.textContent = 'Model load failed'; combineBtn.disabled = true; });
    </script>
  </body>
</html>
